{% extends 'core/base.html' %}
{% load static %}

{% block title %}Hồ sơ - {{ user.username }} | MangaHub{% endblock %}

{% block content %}
<div class="profile-container">
    <div class="profile-header">
        <div class="profile-avatar">
            <div class="avatar-placeholder">
                <img src="{% static 'core/images/a1.jpg' %}" class="fas fa-user"></img>
            </div>
        </div>
        <div class="profile-info">
            <h1>{{ user.username }}</h1>
            <p class="profile-email">{{ user.email }}</p>
            <p class="profile-join-date">Tham gia từ: {{ user.date_joined|date:"d/m/Y" }}</p>
            <div class="profile-stats">
                <div class="stat-item">
                    <span class="stat-number">{{ favorite_count|default:0 }}</span>
                    <span class="stat-label">Yêu thích</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">{{ reading_count|default:0 }}</span>
                    <span class="stat-label">Đã đọc</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">{{ comment_count|default:0 }}</span>
                    <span class="stat-label">Bình luận</span>
                </div>
            </div>
        </div>
    </div>

    <div class="profile-tabs">
        <button class="tab-button active" data-tab="favorites">Truyện yêu thích</button>
        <button class="tab-button" data-tab="history">Lịch sử đọc</button>
        <button class="tab-button" data-tab="settings">Cài đặt</button>
    </div>

    <div class="tab-content">
        <div id="favorites" class="tab-pane active">
            {% if favorites %}
            <div class="comic-grid">
                {% for favorite in favorites %}
                <div class="comic-card">
                    <a href="{% url 'comic_detail' favorite.comic.id %}">
                        {% if favorite.comic.cover_image %}
                        <img src="{{ favorite.comic.cover_image.url }}" alt="{{ favorite.comic.title }}" class="comic-cover">
                        {% else %}
                        <div class="comic-cover no-image">
                            <i class="fas fa-book"></i>
                        </div>
                        {% endif %}
                        <div class="comic-info">
                            <h3 class="comic-title">{{ favorite.comic.title }}</h3>
                            <p class="comic-author">{{ favorite.comic.author|default:"Đang cập nhật" }}</p>
                        </div>
                    </a>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-heart"></i>
                </div>
                <h3 class="empty-title">Chưa có truyện yêu thích</h3>
                <p class="empty-description">Hãy thêm truyện vào danh sách yêu thích để xem ở đây!</p>
                <a href="{% url 'comic_list' %}" class="btn btn-primary">Khám phá truyện</a>
            </div>
            {% endif %}
        </div>

<!-- Tab Lịch sử đọc -->
<div id="history" class="tab-pane">
    {% if reading_history %}
    <div class="history-list">
        {% for history in reading_history %}
        <div class="history-item">
            <a href="{% url 'read_chapter' history.chapter.id %}" class="history-link">
                <div class="history-comic-info">
                    {% if history.chapter.comic.cover_image %}
                    <img src="{{ history.chapter.comic.cover_image.url }}" alt="{{ history.chapter.comic.title }}" class="history-cover">
                    {% else %}
                    <div class="history-cover no-image-small">
                        <i class="fas fa-book"></i>
                    </div>
                    {% endif %}
                    <div class="history-details">
                        <h4 class="history-comic-title">{{ history.chapter.comic.title }}</h4>
                        <p class="history-chapter-info">
                            Chapter {{ history.chapter.chapter_number }} - {{ history.chapter.title }}
                        </p>
                        <span class="read-time">{{ history.read_at|timesince }} trước</span>
                    </div>
                </div>
            </a>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">
            <i class="fas fa-history"></i>
        </div>
        <h3 class="empty-title">Chưa có lịch sử đọc</h3>
        <p class="empty-description">Lịch sử đọc truyện của bạn sẽ hiển thị tại đây!</p>
        <a href="{% url 'comic_list' %}" class="btn btn-primary">Bắt đầu đọc</a>
    </div>
    {% endif %}
</div>

        <!-- Tab Cài đặt -->
        <div id="settings" class="tab-pane">
            <div class="settings-form">
                <h3>Cài đặt tài khoản</h3>
                <form method="post">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="username">Tên đăng nhập</label>
                        <input type="text" id="username" value="{{ user.username }}" readonly>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" value="{{ user.email }}">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Cập nhật thông tin</button>
                    </div>
                </form>
                
                {% if messages %}
                <div class="messages">
                    {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}">{{ message }}</div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
/* Profile Container */
.profile-container {
    max-width: 1200px;
    margin: 20px auto;
    padding: 20px;
    background: #1e1e2f;
    border-radius: 16px;
    color: #fff;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

/* Profile Header */
.profile-header {
    display: flex;
    align-items: center;
    padding: 40px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    margin-bottom: 30px;
    position: relative;
    overflow: hidden;
}

.profile-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.1);
}

/* .profile-avatar {
    position: relative;
    z-index: 2;
    margin-right: 30px;
} */
.profile-avatar {
    width: 130px;
    height: 130px;
    border-radius: 50%;
    overflow: hidden;
    border: 3px solid #ddd;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
    background-color: #f8f8f8;
    display: flex;
    justify-content: center;
    align-items: center;
}

.profile-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover; /* đảm bảo ảnh không méo */
    border-radius: 50%;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

/* Hiệu ứng hover nhẹ */
.profile-avatar:hover img {
    transform: scale(1.05);
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.25);
}


.avatar-placeholder {
    width: 140px;
    height: 140px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3.5rem;
    border: 4px solid rgba(255, 255, 255, 0.3);
    color: rgba(255, 255, 255, 0.7);
}

.profile-info {
    position: relative;
    z-index: 2;
    flex: 1;
}

.profile-info h1 {
    margin: 0 0 8px 0;
    font-size: 2.8rem;
    font-weight: 700;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.profile-email {
    margin: 0 0 8px 0;
    font-size: 1.1rem;
    opacity: 0.9;
}

.profile-join-date {
    margin: 0 0 20px 0;
    opacity: 0.7;
    font-size: 0.95rem;
}

.profile-stats {
    display: flex;
    gap: 40px;
}

.stat-item {
    text-align: center;
    cursor: pointer;
    transition: transform 0.3s ease;
}

.stat-item:hover {
    transform: translateY(-2px);
}

.stat-number {
    display: block;
    font-size: 2.2rem;
    font-weight: 700;
    color: #ff6f61;
    margin-bottom: 4px;
}

.stat-label {
    font-size: 0.95rem;
    opacity: 0.9;
    font-weight: 500;
}

.profile-tabs {
    display: flex;
    border-bottom: 2px solid #333;
    margin-bottom: 30px;
    background: #2a2a3d;
    border-radius: 8px 8px 0 0;
    overflow: hidden;
}

.tab-button {
    flex: 1;
    padding: 18px 24px;
    background: none;
    border: none;
    color: #fff;
    cursor: pointer;
    font-size: 1.05rem;
    font-weight: 500;
    transition: all 0.3s ease;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.tab-button::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: #ff6f61;
    transform: scaleX(0);
    transition: transform 0.3s ease;
}

.tab-button.active {
    background: rgba(255, 111, 97, 0.1);
    color: #ff6f61;
}

.tab-button.active::after {
    transform: scaleX(1);
}

.tab-button:hover:not(.active) {
    background: rgba(255, 255, 255, 0.05);
    color: #ff856f;
}

.tab-content {
    min-height: 400px;
}

.tab-pane {
    display: none;
    animation: fadeIn 0.3s ease;
}

.tab-pane.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}


.comic-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 24px;
}

.comic-card {
    background: #2a2a3d;
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.3s ease;
    position: relative;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
}

.comic-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.comic-cover {
    width: 100%;
    height: 300px;
    object-fit: cover;
    display: block;
}

.no-image {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: rgba(255, 255, 255, 0.7);
    font-size: 3rem;
}

.comic-info {
    padding: 16px;
}

.comic-title {
    margin: 0 0 8px 0;
    font-size: 1.05rem;
    font-weight: 600;
    line-height: 1.3;
    display: -webkit-box;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.comic-author {
    margin: 0 0 12px 0;
    opacity: 0.7;
    font-size: 0.9rem;
}

.history-list {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.history-item {
    background: #2a2a3d;
    border-radius: 12px;
    padding: 20px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
}

.history-item:hover {
    background: #323247;
    transform: translateX(4px);
}

.history-link {
    flex: 1;
    text-decoration: none;
    color: inherit;
}

.history-comic-info {
    display: flex;
    align-items: center;
    gap: 16px;
}

.history-cover {
    width: 70px;
    height: 90px;
    object-fit: cover;
    border-radius: 6px;
    flex-shrink: 0;
}

.no-image-small {
    width: 70px;
    height: 90px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: rgba(255, 255, 255, 0.7);
    font-size: 1.5rem;
}

.history-details {
    flex: 1;
}

.history-comic-title {
    margin: 0 0 6px 0;
    font-size: 1.1rem;
    font-weight: 600;
}

.history-chapter-info {
    margin: 0 0 6px 0;
    opacity: 0.8;
    font-size: 0.95rem;
}

.read-time {
    font-size: 0.85rem;
    opacity: 0.6;
}

/* Settings Form */
.settings-form {
    max-width: 600px;
}

.form-group {
    margin-bottom: 24px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.9);
}

.form-group input {
    width: 100%;
    padding: 12px 16px;
    border-radius: 8px;
    border: 1px solid #444;
    background: #2a2a3d;
    color: white;
    font-size: 1rem;
    transition: all 0.3s ease;
}

.form-group input:focus {
    outline: none;
    border-color: #ff6f61;
    box-shadow: 0 0 0 3px rgba(255, 111, 97, 0.1);
}

.form-group input:read-only {
    background: #333;
    opacity: 0.7;
    cursor: not-allowed;
}

.form-actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 1rem;
}

.btn-primary {
    background: #ff6f61;
    color: white;
}

.btn-primary:hover {
    background: #ff856f;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 111, 97, 0.3);
}

/* Messages */
.messages {
    margin-top: 20px;
}

.alert {
    padding: 16px 20px;
    border-radius: 8px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 12px;
    font-weight: 500;
}

.alert-success {
    background: rgba(39, 174, 96, 0.1);
    color: #27ae60;
    border: 1px solid rgba(39, 174, 96, 0.3);
}

.alert-info {
    background: rgba(52, 152, 219, 0.1);
    color: #3498db;
    border: 1px solid rgba(52, 152, 219, 0.3);
}

.alert-error {
    background: rgba(231, 76, 60, 0.1);
    color: #e74c3c;
    border: 1px solid rgba(231, 76, 60, 0.3);
}

/* Empty States */
.empty-state {
    text-align: center;
    padding: 80px 40px;
    opacity: 0.7;
}

.empty-icon {
    font-size: 4rem;
    margin-bottom: 24px;
    opacity: 0.5;
    color: #ff6f61;
}

.empty-title {
    margin: 0 0 12px 0;
    font-size: 1.5rem;
    font-weight: 600;
}

.empty-description {
    margin: 0 0 24px 0;
    font-size: 1.05rem;
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
    line-height: 1.5;
}

/* Responsive Design */
@media (max-width: 1024px) {
    .comic-grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
    }
}

@media (max-width: 768px) {
    .profile-container {
        margin: 10px;
        padding: 15px;
    }
    
    .profile-header {
        flex-direction: column;
        text-align: center;
        padding: 30px 20px;
    }
    
    .profile-avatar {
        margin-right: 0;
        margin-bottom: 20px;
    }
    
    .profile-info h1 {
        font-size: 2.2rem;
    }
    
    .profile-stats {
        justify-content: center;
        gap: 30px;
    }
    
    .profile-tabs {
        flex-direction: column;
    }
    
    .tab-button {
        padding: 15px;
        justify-content: flex-start;
    }
    
    .comic-grid {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 16px;
    }
    
    .comic-cover {
        height: 240px;
    }
    
    .history-item {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
    }
    
    .form-actions {
        flex-direction: column;
    }
    
    .btn {
        justify-content: center;
    }
}

@media (max-width: 480px) {
    .profile-stats {
        gap: 20px;
    }
    
    .stat-number {
        font-size: 1.8rem;
    }
    
    .comic-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }
    
    .comic-cover {
        height: 200px;
    }
    
    .history-comic-info {
        flex-direction: column;
        text-align: center;
        gap: 12px;
    }
    
    .history-details {
        text-align: center;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tab functionality
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabPanes = document.querySelectorAll('.tab-pane');
    
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');
            
            // Remove active class from all buttons and panes
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabPanes.forEach(pane => pane.classList.remove('active'));
            
            // Add active class to current button and pane
            this.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        });
    });

    // Form submission feedback
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const submitBtn = this.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';
                submitBtn.disabled = true;
                
                // Re-enable button after 3 seconds in case of error
                setTimeout(() => {
                    submitBtn.innerHTML = 'Cập nhật thông tin';
                    submitBtn.disabled = false;
                }, 3000);
            }
        });
    }

    // Add hover effects to comic cards
    const comicCards = document.querySelectorAll('.comic-card');
    comicCards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-8px)';
            this.style.boxShadow = '0 8px 32px rgba(0, 0, 0, 0.3)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '0 4px 16px rgba(0, 0, 0, 0.2)';
        });
    });

    // Add click animation to stat items
    const statItems = document.querySelectorAll('.stat-item');
    statItems.forEach(item => {
        item.addEventListener('click', function() {
            // Add pulse animation
            this.style.animation = 'pulse 0.5s ease';
            setTimeout(() => {
                this.style.animation = '';
            }, 500);
            
            // Determine which tab to open based on the stat clicked
            const statLabel = this.querySelector('.stat-label').textContent.trim();
            let targetTab = 'favorites';
            
            if (statLabel === 'Yêu thích') targetTab = 'favorites';
            else if (statLabel === 'Đã đọc') targetTab = 'history';
            else if (statLabel === 'Bình luận') targetTab = 'comments';
            
            // Switch to the corresponding tab
            const targetButton = document.querySelector(`.tab-button[data-tab="${targetTab}"]`);
            if (targetButton) {
                targetButton.click();
            }
        });
    });

    // Add CSS for pulse animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    `;
    document.head.appendChild(style);

    // Auto-hide messages after 5 seconds
    const messages = document.querySelectorAll('.alert');
    messages.forEach(message => {
        setTimeout(() => {
            message.style.opacity = '0';
            message.style.transform = 'translateY(-10px)';
            message.style.transition = 'all 0.5s ease';
            
            setTimeout(() => {
                if (message.parentNode) {
                    message.parentNode.removeChild(message);
                }
            }, 500);
        }, 5000);
    });

    // Add loading state to empty state buttons
    const emptyStateButtons = document.querySelectorAll('.empty-state .btn');
    emptyStateButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang chuyển hướng...';
        });
    });

    // Enhanced form validation
    const emailInput = document.getElementById('email');
    if (emailInput) {
        emailInput.addEventListener('blur', function() {
            const email = this.value.trim();
            if (email && !isValidEmail(email)) {
                this.style.borderColor = '#e74c3c';
                showFieldError(this, 'Email không hợp lệ');
            } else {
                this.style.borderColor = '#444';
                clearFieldError(this);
            }
        });
    }

    // Helper function to validate email
    function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    // Helper function to show field error
    function showFieldError(field, message) {
        clearFieldError(field);
        
        const errorDiv = document.createElement('div');
        errorDiv.className = 'field-error';
        errorDiv.textContent = message;
        errorDiv.style.color = '#e74c3c';
        errorDiv.style.fontSize = '0.85rem';
        errorDiv.style.marginTop = '5px';
        
        field.parentNode.appendChild(errorDiv);
    }

    // Helper function to clear field error
    function clearFieldError(field) {
        const existingError = field.parentNode.querySelector('.field-error');
        if (existingError) {
            existingError.remove();
        }
    }

    // Add keyboard navigation for tabs
    document.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
            const activeTab = document.querySelector('.tab-button.active');
            if (activeTab) {
                let nextTab;
                
                if (e.key === 'ArrowRight') {
                    nextTab = activeTab.nextElementSibling || document.querySelector('.tab-button:first-child');
                } else {
                    nextTab = activeTab.previousElementSibling || document.querySelector('.tab-button:last-child');
                }
                
                if (nextTab) {
                    nextTab.click();
                    nextTab.focus();
                }
            }
        }
    });

    // Add touch swipe support for mobile
    let touchStartX = 0;
    let touchEndX = 0;
    
    const tabContent = document.querySelector('.tab-content');
    if (tabContent) {
        tabContent.addEventListener('touchstart', function(e) {
            touchStartX = e.changedTouches[0].screenX;
        });
        
        tabContent.addEventListener('touchend', function(e) {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        });
    }
    
    function handleSwipe() {
        const swipeThreshold = 50;
        
        if (touchEndX < touchStartX - swipeThreshold) {
            // Swipe left - go to next tab
            const activeTab = document.querySelector('.tab-button.active');
            const nextTab = activeTab.nextElementSibling || document.querySelector('.tab-button:first-child');
            if (nextTab) nextTab.click();
        }
        
        if (touchEndX > touchStartX + swipeThreshold) {
            // Swipe right - go to previous tab
            const activeTab = document.querySelector('.tab-button.active');
            const prevTab = activeTab.previousElementSibling || document.querySelector('.tab-button:last-child');
            if (prevTab) prevTab.click();
        }
    }
});
</script>
{% endblock %}